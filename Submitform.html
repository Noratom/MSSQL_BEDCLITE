<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contractor Registration</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .error-message {
      color: red;
      font-size: 0.9em;
      margin-top: 2px;
      min-height: 18px;
    }
    
  </style>
</head>
<body>
  <div class="container">
      <!-- Logo placeholder -->
  <div class="logo-container">
    <img src="img/BEDC-Logo-new-dark-1.png" alt="Company Logo" />
  </div>
  
    <h1>Contractor Registration Form</h1>

    <ul class="progress-bar">
      <li class="active" data-step="1">Company Info</li>
      <li data-step="2">Principal Person 1</li>
      <li data-step="3">Principal Person 2</li>
      <li data-step="4">Documents Upload</li>
    </ul>

    <form id="principalPersonsForm" enctype="multipart/form-data">

      <!-- Section 1 -->
      <div class="section active">
        <h2>Company Information</h2>
        <label>Company Name</label>
        <input type="text" id="contractorName" name="contractorNameDisplay" readonly />
        <input type="hidden" id="contractorNameHidden" name="contractorName" />

        <label>Address</label>
        <input type="text" id="contractorAddress" name="contractorAddressDisplay" readonly />
        <input type="hidden" id="contractorAddressHidden" name="contractorAddress" />

        <label>Phone Number</label>
        <input type="tel" id="phoneNo" name="phoneNoDisplay" readonly />
        <input type="hidden" id="phoneNoHidden" name="phoneNo" />

        <label>Email Address</label>
        <input type="email" id="email" name="emailDisplay" readonly />
        <input type="hidden" id="emailHidden" name="email" />

        <label>BEDC Registration Number</label>
        <input type="text" id="bedcRegNo" name="bedcRegNoDisplay" readonly />
        <input type="hidden" id="bedcRegNoHidden" name="bedcRegNo" />

        <div class="nav-buttons">
          <span></span>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Section 2 -->
      <div class="section">
        <h2>Principal Person 1</h2>
        <label>First Name</label>
        <input type="text" id="pPersonFName1" name="pPersonFName1" required />

        <label>Middle Name</label>
        <input type="text" id="pPersonMName1" name="pPersonMName1" required />

        <label>Last Name</label>
        <input type="text" id="pPersonLName1" name="pPersonLName1" required />

        <label>Position</label>
        <input type="text" id="pPersonPosition1" name="pPersonPosition1" required />

        <label>Phone Number</label>
        <input type="tel" id="pPersonPhoneNo1" name="pPersonPhoneNo1" required />
        <div id="errorPPersonPhoneNo1" class="error-message"></div>

        <div class="nav-buttons">
          <button type="button" class="back-btn">Back</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Section 3 -->
      <div class="section">
        <h2>Principal Person 2</h2>
        <label>First Name</label>
        <input type="text" id="pPersonFName2" name="pPersonFName2" required />

        <label>Middle Name</label>
        <input type="text" id="pPersonMName2" name="pPersonMName2" required />

        <label>Last Name</label>
        <input type="text" id="pPersonLName2" name="pPersonLName2" required />

        <label>Position</label>
        <input type="text" id="pPersonPosition2" name="pPersonPosition2" required />

        <label>Phone Number</label>
        <input type="tel" id="pPersonPhoneNo2" name="pPersonPhoneNo2" required />
        <div id="errorPPersonPhoneNo2" class="error-message"></div>

        <div class="nav-buttons">
          <button type="button" class="back-btn">Back</button>
          <button type="button" class="next-btn">Next</button>
        </div>
      </div>

      <!-- Section 4 -->
      <div class="section">
        <h2>Documents Upload</h2>

        <label>BEDC Certificate</label>
        <input type="file" id="BEDCCertificate" name="BEDCCertificate" accept="image/*" required />

        <label>NEMSA/COREN Practicing License</label>
        <input type="file" id="ValidNEMSALicense" name="ValidNEMSALicense" accept="image/*" required />

        <label>
          <input type="checkbox" name="vendorConsent" value="true" required />
          I consent to verification.
        </label>

        <div class="nav-buttons">
          <button type="button" class="back-btn">Back</button>
          <button type="submit">Submit</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    let container;
    try {
      container = JSON.parse(localStorage.getItem("contract"));
      if (!container) throw new Error();
    } catch (e) {
      alert("No contractor data found. Please start from the beginning.");
      window.location.href = "index.html";
    }

    document.getElementById("contractorName").value = container.contractorName || "";
    document.getElementById("contractorNameHidden").value = container.contractorName || "";
    document.getElementById("contractorAddress").value = container.contractorAddress || "";
    document.getElementById("contractorAddressHidden").value = container.contractorAddress || "";
    document.getElementById("phoneNo").value = container.PhoneNo || "";
    document.getElementById("phoneNoHidden").value = container.PhoneNo || "";
    document.getElementById("email").value = container.contractorEmail || "";
    document.getElementById("emailHidden").value = container.contractorEmail || "";
    document.getElementById("bedcRegNo").value = container.BEDCRegNumber || "";
    document.getElementById("bedcRegNoHidden").value = container.BEDCRegNumber || "";

    const sections = document.querySelectorAll(".section");
    let currentStep = 0;

    function showStep(index) {
      sections.forEach((sec, i) => {
        sec.classList.toggle("active", i === index);
      });
      updateProgressBar(index);
    }

    function updateProgressBar(step) {
      const progressItems = document.querySelectorAll(".progress-bar li");
      progressItems.forEach((item, i) => {
        item.classList.toggle("active", i === step);
      });
    }

    function nextStep() {
      if (currentStep < sections.length - 1) {
        currentStep++;
        showStep(currentStep);
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    }

    function isValidPhone(phone) {
      return /^\d{1,11}$/.test(phone);
    }

    function validateSection(section) {
      const inputs = section.querySelectorAll("input[required]");
      let valid = true;

      section.querySelectorAll(".error-message").forEach(em => em.textContent = "");

      for (let input of inputs) {
        const errorId = "error" + input.id.charAt(0).toUpperCase() + input.id.slice(1);
        const errorField = document.getElementById(errorId);

        if (input.type === "file" && input.files.length === 0) {
          alert("Please upload all required documents.");
          return false;
        } else if (input.type === "checkbox" && !input.checked) {
          alert("Please check the consent checkbox.");
          return false;
        } else if (input.type !== "file" && input.type !== "checkbox" && input.value.trim() === "") {
          alert("Please fill out all required fields.");
          return false;
        }

        if (input.id.toLowerCase().includes("phoneno") && !isValidPhone(input.value.trim())) {
          if (errorField) {
            errorField.textContent = "Enter a valid phone number (up to 11 digits)";
          }
          valid = false;
        }
      }

      return valid;
    }

    document.addEventListener("DOMContentLoaded", () => {
      showStep(currentStep);

      document.querySelectorAll(".next-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          if (validateSection(sections[currentStep])) {
            nextStep();
          }
        });
      });

      document.querySelectorAll(".back-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          prevStep();
        });
      });

      document.getElementById("principalPersonsForm").addEventListener("submit", function (e) {
        e.preventDefault();

        if (validateSection(sections[sections.length - 1])) {
          const formData = new FormData(this);
          formData.set("contractorName", document.getElementById("contractorNameHidden").value);
          formData.set("contractorAddress", document.getElementById("contractorAddressHidden").value);
          formData.set("phoneNo", document.getElementById("phoneNoHidden").value);
          formData.set("email", document.getElementById("emailHidden").value);
          formData.set("bedcRegNo", document.getElementById("bedcRegNoHidden").value);

          fetch("http://localhost:4000/newform/submitContractor", {
            method: "POST",
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            alert("Submission successful!");
            window.location.href = "network-construction.html";
          })
          .catch(err => {
            console.error(err);
            alert("There was an error submitting the form.");
          });
        }
      });
    });
  </script>
</body>
</html>
